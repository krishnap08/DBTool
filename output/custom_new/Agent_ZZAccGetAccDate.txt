--Copyright NuView Systems, Inc. 2007--
--7/26/2007 INT SKA - Calculate Accrual Start and End Dates

CREATE FUNCTION ZZAccGetAccDates (@prm_sEmp nVarChar(15), @prm_sTcl nVarChar(15), @RunDt DateTime = NULL)
RETURNS @TmpDates Table (PeriodStDT DateTime , PeriodEdDT DateTime)
AS
BEGIN
  DECLARE @Tcl nVarChar(15),@TclMnth nVarChar(2), @TclDay nVarChar(2), @IsScheduled Bit, @IsAnniversary Bit, @BeginDtFld nVarChar(MAX),@Eml nVarChar(15)
  DECLARE @StartDT Datetime, @EndDT DateTime, @CurDate DateTime
  SELECT @IsScheduled = IsScheduled, @TclMnth = TclMnth, @TclDay = TclDay FROM Tcl WHERE Tcl = @prm_sTcl
  SELECT @CurDate = CurDte from NuDateCurDate
  SET @BeginDtFld = (SELECT HireDt FROM Emp WHERE Emp = @prm_sEmp AND EmpEfdDt IS NULL)
  IF @RunDt IS NULL
  BEGIN
    SET @RunDt = @CurDate
  END
  IF @IsScheduled = 1
  BEGIN
    IF ISNULL(@TclMnth,'') = ''
      SET @TclMnth = '01'
    IF ISNULL(@TclDay,'') = ''
      SET @TclDay = '01'
    SET @StartDT = dbo.NuDateFromParts(Year(@RunDt), @TclMnth, @TclDay, 0, 0, 0, 0)
    SET @EndDT = DateAdd(ss,-1,DateAdd(Year, 1, @StartDT))
    IF @BeginDtFld > @StartDT
    BEGIN 
      Set @StartDT = dbo.NuDateFromParts((Year(@CurDate)), MONTH(@BeginDtFld), DAY(@BeginDtFld), 0, 0, 0, 0)
    END
  END
  ELSE IF @IsScheduled <> 1
  BEGIN
    SELECT @StartDT = dbo.NuDateFromParts((Year(@RunDt)), MONTH(@BeginDtFld), DAY(@BeginDtFld), 0, 0, 0, 0)
    SELECT @EndDT = DateAdd(ss,-1,DateAdd(Year, 1, @StartDT))
  END
  INSERT @TmpDates (PeriodStDT, PeriodEdDT)
  SELECT (CASE WHEN @RunDt BETWEEN @StartDT AND @EndDT THEN @StartDT ELSE DateAdd(yyyy, -1, @StartDT) END) AS 'PeriodStDT', (CASE WHEN @RunDt BETWEEN @StartDT AND @EndDT THEN @EndDT ELSE DateAdd(yyyy, -1, @EndDT) END) AS 'PeriodEdDT'
  RETURN
END
